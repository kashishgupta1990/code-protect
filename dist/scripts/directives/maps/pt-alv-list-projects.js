define(["app","text!views/directives/maps/pt-alv-list-projects.html","directives/maps/pt-alv-listitem-project","services/pageSettings"],function(a,b){a.directive("ptAlvListProjects",["$parse","$rootScope","pageSettings","$timeout","$filter","$location",function(a,c,d,e,f,g){return{restrict:"EA",scope:{},template:b,controller:["$scope",function(a){a.$on("updateALVLocation",function(b,c){switch(c.showPreviousLabel&&(c.label=a.label),c.type){case"builder":a.entityType="builder",a.cityLabel=c.cityLabel,a.label=c.label||"locality center";break;case"locality":default:a.entityType="locality",a.distance=c.distance,a.label=c.label||"selected builder"}})}],link:function(a,b){a.alvList=[],a.unMappedCount=0,a.showUnMapped=!1;var h=[];a.showUnMappedValue="!",a.perPageItem=d.defaultSettings.perPageCount||20;var i={relevance:"",projectLivabilityScore:"-livabilityScore",ASC:"minResaleOrPrimaryPrice",DESC:"-maxResaleOrPrimaryPrice",possessionDate:"possessionDateTstamp"};a.$on("$destroy",function(){h=[],b.remove()}),a.alvSortOptions=[{key:"",label:"Sort by Relevance"},{key:"minResaleOrPrimaryPrice",label:"Sort by Price (Low to High)"},{key:"-maxResaleOrPrimaryPrice",label:"Sort by Price (High to Low)"},{key:"possessionDateTstamp",label:"Sort by Possession Date"},{key:"-livabilityScore",label:"Sort by Livability (High to Low)"}],a.alvSortingValue="",a.sortResults=function(b){var d="",e="type";if(g.search("ord",null),a.alvSortingValue)if("minResaleOrPrimaryPrice"==a.alvSortingValue){var i=f("filter")(a.alvList,{minResaleOrPrimaryPrice:"!"});a.alvList=f("orderBy")(h,a.alvSortingValue),a.alvList=f("filter")(a.alvList,{minResaleOrPrimaryPrice:"!!"}),a.alvList=a.alvList.concat(i),e="rate",d="PriceLowToHigh",g.search("sortType","minResaleOrPrimaryPrice"),g.search("ord","ASC")}else if("-maxResaleOrPrimaryPrice"==a.alvSortingValue){var i=f("filter")(a.alvList,{maxResaleOrPrimaryPrice:"!"});a.alvList=f("orderBy")(h,a.alvSortingValue),a.alvList=f("filter")(a.alvList,{maxResaleOrPrimaryPrice:"!!"}),a.alvList=a.alvList.concat(i),e="rate",d="PriceHighToLow",g.search("sortType","minResaleOrPrimaryPrice"),g.search("ord","DESC")}else if("possessionDateTstamp"==a.alvSortingValue){var j=(new Date).getFullYear()-2,i=f("filter")(h,function(a,b){return a.possessionFullYear<j});a.alvList=f("filter")(h,function(a,b){return a.possessionFullYear>=j}),a.alvList=f("orderBy")(a.alvList,a.alvSortingValue),a.alvList=a.alvList.concat(i),e="date",d="possessionDate",g.search("sortType","possessionDate")}else a.alvList=f("orderBy")(h,a.alvSortingValue),"-livabilityScore"==a.alvSortingValue&&(e="livability",d="projectLivabilityScore",g.search("sortType","projectLivabilityScore"));else d="relevance",a.alvList=h,g.search("sortType","relevance");c.$broadcast("markerDisplayType",e)},a.$on("showAlvListItemProjects",function(b,d){h=angular.copy(d.projects),a.alvList=d.projects,d.ord&&i[d.ord]?(a.alvSortingValue=i[d.ord],a.sortResults()):d.sortBy&&i[d.sortBy]&&(a.alvSortingValue=i[d.sortBy],a.sortResults()),a.unMappedCount=d.unMappedCount,c.$broadcast("updateScroll")}),a.$on("info:scrollUpdate",function(){!a.showUnMapped&&a.alvList.length-a.unMappedCount>a.perPageItem?(a.perPageItem+=d.defaultSettings.perPageCount,c.$broadcast("updateScroll",{dontScrollToTop:!0})):a.showUnMapped&&a.unMappedCount>a.perPageItem&&(a.perPageItem+=d.defaultSettings.perPageCount,c.$broadcast("updateScroll",{dontScrollToTop:!0})),e(function(){a.$apply()},0)}),a.$on("showMapped",function(b,c){a.showUnMapped=c,j()});var j=function(){var b="";return a.showUnMapped?(a.showUnMappedValue="!",a.showUnMapped=!1,b="Unmapped"):(a.showUnMappedValue="!!",a.showUnMapped=!0,b="Mapped"),a.perPageItem=d.defaultSettings.perPageCount||20,c.$broadcast("updateScroll"),b};a.toggleMappedProject=function(){var b="";c.CURRENT_ACTIVE_PAGE,b=j(),c.$broadcast("toggleMappedProject",a.showUnMapped)}}}}])});