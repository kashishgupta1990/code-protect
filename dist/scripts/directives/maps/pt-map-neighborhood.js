define(["app","services/localityService","parsers/projectParser","services/mapFactory","services/markerFactory","directives/maps/neighborhood-palette"],function(a){a.directive("ptMapNeighborhood",["mapFactory","markerFactory","ProjectParser","$rootScope","LocalityService",function(a,b,c,d,e){return{restrict:"EAC",scope:{mapId:"=",data:"=",marker:"=",markerType:"=",radius:"=",direction:"="},template:'<div id="{{mapId}}" class="map_container"></div><div neighborhood-palette activate="activate(key)" radius="radius" data="data" deactivate="deactivate(key)" class="nearby-palette"></div>',controller:["$scope",function(c){function f(b,c,d,e){return 0!==d.length?(a.action.markers.add(b,d),c=new Overlay(d,b),c.setMap(b),a.action.bounds(b,d,e),c):void google.maps.event.addListener(b,"idle",function(){google.maps.event.trigger(b,"resize"),a.action.bounds(b,d,e)})}function g(d,g){var h,i;c.activate=function(a){void 0!==i&&a!==i?c.deactivate(a):i=a;var k=new google.maps.LatLngBounds,l=new google.maps.LatLng(g.lat,g.lng),m=c.radius,n=[];k.extend(l),e.getNeighbourhood(g,m,a,function(e){if(e.length){for(var g=0;g<e.length;g++){e[g].__direction__=c.direction;var i=new b.marker(a,e[g]);e[g].__direction__||(e[g].__tooltip__=e[g].name),c.direction&&i.mouseEnter(j),n.push(i)}c.deactivate(a),h=f(d,h,n,k)}})},c.deactivate=function(b){h&&(h.destroy(),h=void 0,a.action.direction.remove())}}function h(){var d,e,f,h,i,j={zoom:12,zoomControl:!1,zoomControlOptions:{style:google.maps.ZoomControlStyle.LARGE,position:google.maps.ControlPosition.RIGHT_TOP},mapTypeControl:!0,scaleControl:!1,center:{lat:c.data.latitude,lng:c.data.longitude}};d=c.mapId,e=a.initialize(j,d),c.marker===!0&&"normal"===c.markerType&&(c.data.neighborhood=void 0,f=c.data,h=new b.marker("project",f),a.action.markers.add(e,[h]),i=new Overlay([h],e),i.setMap(e),google.maps.event.addListener(e,"idle",function(){$("#project_"+c.data.projectId).addClass("st-c")})),c.marker===!0&&"simple"===c.markerType&&a.action.markers.simple(e,[{latitude:c.data.latitude,longitude:c.data.longitude,title:c.data.fullName}]),g(e,{lat:c.data.latitude,lng:c.data.longitude}),c.activate("school"),$("body").delegate(".map-zoomin","click",function(){var a=e.getZoom()+1;e.setZoom(a)}),$("body").delegate(".map-zoomout","click",function(){var a=e.getZoom()-1;e.setZoom(a)})}function i(){setTimeout(h)}d.$broadcast("markerDisplayType","type");var j=function(b){var d=String(b.latitude).replace(".","")+"-"+String(b.longitude).replace(".",""),e={source:{lat:c.data.latitude,lng:c.data.longitude},destination:[{lat:b.latitude,lng:b.longitude}]},f=function(a,b){var c=$("#"+d).find(".waiting");"OK"!==a||c.hasClass("completed")||(c.addClass("completed"),c.html('<span class="dstnc_wrap"><i class="pt pt-icon-road"></i> '+b.distance+'</span><span class="time_car_wrap"><i class="pt pt-icon-truck"></i> '+b.duration+"</span>"))};a.action.direction.create(e,f)};a.includeJS(i)}]}}])});