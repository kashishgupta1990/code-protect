define(["app","text!views/directives/maps/pt-projectdetail.html","parsers/imageParser","services/leadService","services/introJsService","services/notificationService","services/favoriteService","services/fullScreenService","services/projectService","services/userService","services/maps/mapConfig","services/constants","parsers/projectParser","directives/maps/pt-customDirections","directives/maps/pt-nearby-amenities","directives/common/pt-rating","directives/common/pt-carousel","directives/common/pt-disclaimer","directives/common/pt-loading-block","directives/common/pt-compare-button"],function(a,b){a.directive("ptProjectdetail",["$modal","$cookies","$rootScope","$location","$timeout","ImageParser","LeadService","IntroJsService","NotificationService","FavoriteService","FullScreenService","UserService","Constants","ProjectParser","ProjectService","PtMapsConfig",function(a,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){return{restrict:"A",scope:{},template:b,link:function(a,b){var c;a.map=q.mapConfig,a.data={},a.showDetailFlag=!1,a.data.projectId=null,a.heatMapProgress=[],a.cityUnsupported,a.travelTime={status:"idle"},a.activeTabHash={gallery:!0,price:!1,neighbourhood:!1,timeSense:!1};var i=function(b){for(var c in a.activeTabHash)a.activeTabHash.eachTab=!1,c==b&&(a.activeTabHash[c]=!0)};a.$on("activateProjectDetailCardFirstTab",function(){i("gallery"),a.data.item={type:"gallery",tab:t.gallery}}),a.$on("openProjectDetailCard",function(a,b){c=d.CURRENT_ACTIVE_PAGE,d.CURRENT_ACTIVE_PAGE=n.GLOBAL.PAGE_TYPES.MAP+"-"+n.GLOBAL.PAGE_TYPES.PROJECTDETAIL,r(b.projId,b.callback)}),a.$on("closeProjectDetailCard",function(){s()}),a.$on("timeSenseCardStatus",function(b,c,d){var e;if(d&&(e=d.configs),"completed"===c)a.timeSenseMsg="Completed!",a.timeSenseCardMsg="Hover on heat map to get travel time from project.<br>Click outside to get travel time and distance.";else if("failed"===c)a.timeSenseMsg="Oops! Something went wrong.",a.timeSenseCardMsg="Oops! Something went wrong";else if("preprocessed"===c){if(!e)return;for(var f=0,g=e.length;g>f;f++)a.heatMapProgress.push({range:e[f].range,progress:100,color:e[f].fillColor});a.timeSenseMsg="",a.timeSenseCardMsg="Hover on heat map to get travel time from project.<br>Click outside to get travel time and distance."}}),a.$on("updateTimeSenseProgressOnCard",function(b,c){var d=c.config,e=d.add,f=c.progress,g=-1;if(d.removeRange){a.timeSenseMsg="Fine tuning...",a.timeSenseCardMsg="Fine tuning...";for(var h=0,i=a.heatMapProgress.length;i>h;h++)if(a.heatMapProgress[h].range===d.removeRange){a.heatMapProgress.splice(h,1),g=h;break}}for(var h=0,i=e.length;i>h;h++){var j=_.find(a.heatMapProgress,function(a){return a.range===e[h].range});j?j.progress=f:(j={range:e[h].range,progress:f,color:e[h].fillColor},-1!==g?a.heatMapProgress.splice(g+h,0,j):(a.timeSenseMsg="Drawing Time Sense map...",a.timeSenseCardMsg="Drawing Time Sense map...",a.heatMapProgress.push(j)))}});var k=function(a){var b,c=[],d=[],e=0;if(a&&a.length){for(var f=0,g=a.length;g>f;f++){var h=a[f];"Oth"===h.amenityMaster.abbreviation||e>=12?(d.push(h.amenityDisplayName),b=h,b.amenityMaster.abbreviation="Oth"):(c.push(h),e++)}d.length&&(b.amenityDisplayName=d.join(", "),c.push(b))}return c};a.gallerySettings={width:350,height:240,imageWidth:360,imageHeight:270,showBottomNav:!1,showLabel:!1},a.callerLocation="Project",a.pageType=n.GLOBAL.PAGE_TYPES.MAP+"-"+n.GLOBAL.PAGE_TYPES.PROJECTDETAIL;var r=function(b,c){var e={};a.data={},a.showDetailFlag=!1,i("gallery"),$("#projectLoader, .pro_loader_image").show(),p.getProjectDetail(b,function(b){if($("#projectLoader, .pro_loader_image").hide(),f(function(){$("#gallery a").click()},0),b&&b.data){a.data=o.parseProject(b.data,!0),d.$broadcast("showNearbyAmenities",{latitude:a.data.latitude,longitude:a.data.longitude,projectId:a.data.projectId});var h="465px";if(a.data&&a.data.offers&&a.data.offers.length&&(h="497px"),$(".proj-card-wrap").animate({height:h},500),a.showDetailFlag=!0,a.data.searchedPlacesLocalData=[],d.$broadcast("projectDetailCardOpened",a.data),a.data.amenities&&(a.data.amenities=k(a.data.amenities)),a.data&&a.data.projectId){m.setRecentlyViewed(a.data.projectId,0),a.tabSwitch("gallery","autoOpen");var i=b.data;i.city=a.data.locality.suburb.city.label;var j=g.getProjectImage(i,"type");a.imageData=j.data,a.imageDataFullView=j.data,a.has3dimages=a.data.has3DImages,a.landmarkImageTypeCount=a.data.landmarkImageTypeCount}b.data.images&&b.data.images.length||$(".projectDetailsTabs #gallery").hide(),e["Page Name"]=n.GLOBAL.PAGE_TYPES.MAP+"-"+n.GLOBAL.PAGE_TYPES.PROJECTDETAIL,e["Project ID"]=a.data.projectId,e["Image Available"]=a.data.images.length,e.Comments=0,e["User Participation"]=0,e["Video Count"]=0,a.cityUnsupported=18===d.selectedCity.id||5===d.selectedCity.id||16===d.selectedCity.id,c&&c(a.data)}})};a.mouseAction=function(b){a.map.state.activateToggleCollage&&("enter"==b?a.map.state.collapseState=!1:a.map.state.collapseState=!0)},a.cardClick=function(){a.map.state.activateToggleCollage=!1,a.map.state.collapseState=!1};var s=function(){d.CURRENT_ACTIVE_PAGE===n.GLOBAL.PAGE_TYPES.MAP+"-"+n.GLOBAL.PAGE_TYPES.PROJECTDETAIL&&c&&(d.CURRENT_ACTIVE_PAGE=c),$(".proj-card-wrap").animate({}),a.showDetailFlag=!1,d.$broadcast("projectDetailsClosed",a.data)};a.close=function(){d.$broadcast("closeProjectDetailCard")},a.togglePriceArea=function(a){var b=angular.element(a.currentTarget),c=b.parent().siblings("table");c.hasClass("show-sizes")?c.removeClass("show-sizes"):c.addClass("show-sizes")};var t={gallery:"overview",price:"price"};a.tabSwitch=function(b,c){if(i(b),a.data.unMapped&&("neighbourhood"==b||"timeSense"==b))return void d.$broadcast("showUnmappedNotification");if(a.data.projectId){if({lat:a.data.latitude,lng:a.data.longitude},("neighbourhood"!=b||"timeSense"!=b)&&(a.data.item={type:b,tab:t[b]}),d.$broadcast("projectDetailsTabClicked",{type:b,projectId:a.data.projectId,latitude:a.data.latitude,longitude:a.data.longitude}),"neighbourhood"===b){var e="#project_"+a.data.projectId;$(e).show(function(){})}"timeSense"===b&&(a.travelTime.status="idle",a.heatMapProgress=[],a.cityUnsupported?a.timeSenseMsg="Time sense unavailable in "+d.selectedCity.label+" currently. Coming soon!":a.timeSenseMsg="",a.timeSenseCardMsg="With Time Sense now you can get an overview of time it will take to get to any point around this project.",a.data.item.tab="timeSense")}};var u={type:void 0,cityId:void 0,localityId:void 0,projectId:void 0,projectName:void 0,builderName:void 0,ui_php:void 0,formlocationinfo:void 0};a.getLeadData=function(b,c,d){return u.type=b,u.cityId=a.data.cityId,u.localityId=a.data.localityId,u.projectId=a.data.projectId,u.projectName=a.data.name,u.builderName=a.data.builder&&a.data.builder.name?a.data.builder.name:void 0,u.leadType=a.data.resaleEnquiry?"Resale":"Primary",u.ui_php="mappage.php",u.formlocationinfo=d,c&&(u.propertyDetail=c),u},a.openLeadForm=function(b,c,d){var e=a.getLeadData(b,c,d),f=angular.copy(e);h.openLeadForm(f)},a.openGallery=function(b){if(b.images&&b.images.length){var c=a.data.builder.name+" "+a.data.name;a.images=g.getClusteredImage(b.images,"type");var d=(a.images.data[0].data[0].text?a.images.data[0].data[0].text:"",a.getLeadData(void 0,void 0,"hidden-enquiry-top"));l.openGallery(a.images.data,0,void 0,d),a.images.data[0].data[0].city=a.data.locality.suburb.city.label,a.images.data[0].data[0].locality=a.data.locality.label,a.images.data[0].data[0].mainTitle=c}else j.setNotification({msg:"Floor plan unavailable #"+b.propertyId,type:"info"})},a.projectLinkTracking=function(){"http://"+e.host()+"/"+a.data.URL},a.drawTravelHeatmap=function(){"started"!==a.travelTime.status&&(a.cityUnsupported||(a.travelTime.status="started",a.timeSenseMsg="Drawing Time Sense map...",a.timeSenseCardMsg="Drawing Time Sense map...",d.$broadcast("drawTimeSenseSelected",a.data)))},a.$on("$destroy",function(){c=void 0,a.map=void 0,a.imageData=void 0,a.imageDataFullView=void 0,a.has3dimages=void 0,a.landmarkImageTypeCount=void 0,a.data=void 0,b.remove()})},controller:["$scope",function(a){a.$on("favChanged",function(b){var c=a.data.projectId,d=k.isFav(c),e=$(".projFav_"+c);d?e.addClass("active"):e.removeClass("active")})}]}}])});