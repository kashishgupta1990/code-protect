var system=require("system");system.args.length<3&&(console.log("Missing arguments."),phantom.exit());var server=require("webserver").create(),port=parseInt(system.args[1]),urlPrefix=system.args[2],parse_qs=function(e){var t={},n=document.createElement("a");return n.href=e,n.search.replace(new RegExp("([^?=&]+)(=([^&]*))?","g"),function(e,n,r,s){t[n]=s}),t},renderHtml=function(e,t){var n=require("webpage").create();n.settings.loadImages=!1,n.settings.localToRemoteUrlAccessEnabled=!0,n.onCallback=function(){t(n.content),n.close()},n.onInitialized=function(){n.evaluate(function(){setTimeout(function(){window.callPhantom()},1e4)})},n.open(e)};server.listen(port,function(e,t){var n=parse_qs(e.url)._escaped_fragment_,r=urlPrefix+e.url.slice(1,e.url.indexOf("?"))+"#!"+decodeURIComponent(n);renderHtml(r,function(e){t.statusCode=200,t.write(e),t.close()})}),console.log("Listening on "+port+"..."),console.log("Press Ctrl+C to stop.");