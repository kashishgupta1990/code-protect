/*
 Data plugin for Highcharts

 (c) 2012-2014 Torstein Honsi

 License: www.highcharts.com/license
*/

!function(t){var e=t.each,s=function(t,e){this.init(t,e)};t.extend(s.prototype,{init:function(t,e){this.options=t,this.chartOptions=e,this.columns=t.columns||this.rowsToColumns(t.rows)||[],this.columns.length?this.dataFound():(this.parseCSV(),this.parseTable(),this.parseGoogleSpreadsheet())},getColumnDistribution:function(){var s=this.chartOptions,n=s&&s.chart&&s.chart.type,i=[];e(s&&s.series||[],function(e){i.push((t.seriesTypes[e.type||n||"line"].prototype.pointArrayMap||[0]).length)}),this.valueCount={global:(t.seriesTypes[n||"line"].prototype.pointArrayMap||[0]).length,individual:i}},dataFound:function(){this.options.switchRowsAndColumns&&(this.columns=this.rowsToColumns(this.columns)),this.parseTypes(),this.findHeaderRow(),this.parsed(),this.complete()},parseCSV:function(){var t,s,n=this,i=this.options,o=i.csv,r=this.columns,a=i.startRow||0,l=i.endRow||Number.MAX_VALUE,u=i.startColumn||0,h=i.endColumn||Number.MAX_VALUE,c=0;o&&(s=o.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split(i.lineDelimiter||"\n"),t=i.itemDelimiter||(-1!==o.indexOf("	")?"	":","),e(s,function(s,i){var o=n.trim(s),p=0===o.indexOf("#");i>=a&&l>=i&&!p&&""!==o&&(o=s.split(t),e(o,function(t,e){e>=u&&h>=e&&(r[e-u]||(r[e-u]=[]),r[e-u][c]=t)}),c+=1)}),this.dataFound())},parseTable:function(){var t=this.options,s=t.table,n=this.columns,i=t.startRow||0,o=t.endRow||Number.MAX_VALUE,r=t.startColumn||0,a=t.endColumn||Number.MAX_VALUE;s&&("string"==typeof s&&(s=document.getElementById(s)),e(s.getElementsByTagName("tr"),function(t,s){s>=i&&o>=s&&e(t.children,function(t,e){("TD"===t.tagName||"TH"===t.tagName)&&e>=r&&a>=e&&(n[e-r]||(n[e-r]=[]),n[e-r][s-i]=t.innerHTML)})}),this.dataFound())},parseGoogleSpreadsheet:function(){var t,e,s=this,n=this.options,i=n.googleSpreadsheetKey,o=this.columns,r=n.startRow||0,a=n.endRow||Number.MAX_VALUE,l=n.startColumn||0,u=n.endColumn||Number.MAX_VALUE;i&&jQuery.ajax({dataType:"json",url:"https://spreadsheets.google.com/feeds/cells/"+i+"/"+(n.googleSpreadsheetWorksheet||"od6")+"/public/values?alt=json-in-script&callback=?",error:n.error,success:function(n){var i,h,n=n.feed.entry,c=n.length,p=0,m=0;for(h=0;c>h;h++)i=n[h],p=Math.max(p,i.gs$cell.col),m=Math.max(m,i.gs$cell.row);for(h=0;p>h;h++)h>=l&&u>=h&&(o[h-l]=[],o[h-l].length=Math.min(m,a-r));for(h=0;c>h;h++)i=n[h],t=i.gs$cell.row-1,e=i.gs$cell.col-1,e>=l&&u>=e&&t>=r&&a>=t&&(o[e-l][t-r]=i.content.$t);s.dataFound()}})},findHeaderRow:function(){e(this.columns,function(){}),this.headerRow=0},trim:function(t){return"string"==typeof t?t.replace(/^\s+|\s+$/g,""):t},parseTypes:function(){for(var t,e,s,n,i=this.columns,o=i.length;o--;)for(t=i[o].length;t--;)e=i[o][t],s=parseFloat(e),n=this.trim(e),n==s?(i[o][t]=s,s>31536e6?i[o].isDatetime=!0:i[o].isNumeric=!0):(e=this.parseDate(e),0!==o||"number"!=typeof e||isNaN(e)?i[o][t]=""===n?null:n:(i[o][t]=e,i[o].isDatetime=!0))},dateFormats:{"YYYY-mm-dd":{regex:"^([0-9]{4})-([0-9]{2})-([0-9]{2})$",parser:function(t){return Date.UTC(+t[1],t[2]-1,+t[3])}}},parseDate:function(t){var e,s,n,i=this.options.parseDate;if(i&&(e=i(t)),"string"==typeof t)for(s in this.dateFormats)i=this.dateFormats[s],(n=t.match(i.regex))&&(e=i.parser(n));return e},rowsToColumns:function(t){var e,s,n,i,o;if(t)for(o=[],s=t.length,e=0;s>e;e++)for(i=t[e].length,n=0;i>n;n++)o[n]||(o[n]=[]),o[n][e]=t[e][n];return o},parsed:function(){this.options.parsed&&this.options.parsed.call(this,this.columns)},complete:function(){var e,s,n,i,o,r,a,l,u=this.columns,h=this.options;if(h.complete){for(this.getColumnDistribution(),u.length>1&&(e=u.shift(),0===this.headerRow&&e.shift(),e.isDatetime?s="datetime":e.isNumeric||(s="category")),r=0;r<u.length;r++)0===this.headerRow&&(u[r].name=u[r].shift());for(i=[],r=0,l=0;r<u.length;l++){if(n=t.pick(this.valueCount.individual[l],this.valueCount.global),o=[],r+n<=u.length)for(a=0;a<u[r].length;a++)o[a]=[e[a],void 0!==u[r][a]?u[r][a]:null],n>1&&o[a].push(void 0!==u[r+1][a]?u[r+1][a]:null),n>2&&o[a].push(void 0!==u[r+2][a]?u[r+2][a]:null),n>3&&o[a].push(void 0!==u[r+3][a]?u[r+3][a]:null),n>4&&o[a].push(void 0!==u[r+4][a]?u[r+4][a]:null);i[l]={name:u[r].name,data:o},r+=n}h.complete({xAxis:{type:s},series:i})}}}),t.Data=s,t.data=function(t,e){return new s(t,e)},t.wrap(t.Chart.prototype,"init",function(s,n,i){var o=this;n&&n.data?t.data(t.extend(n.data,{complete:function(r){n.series&&e(n.series,function(e,s){n.series[s]=t.merge(e,r.series[s])}),n=t.merge(r,n),s.call(o,n,i)}}),n):s.call(o,n,i)})}(Highcharts);